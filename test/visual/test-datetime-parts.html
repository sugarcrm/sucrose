<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=320" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Date Ranges</title>
  <link rel="stylesheet" href="visual-tests.css">
  <script src="../../build/d3.min.js"></script>
  <style>
  body {
    font-family: monospace;
  }
  </style>
</head>
<body>
  <div class="sc-demo sc-demo-locale">
  </div>
<script>
var fiscalYear = new Date(2017, 0, 1, 0, 0, 0).toUTCString();
var value;
var spec;

printf('===========');

value = dv('2017', 'year');
spec = ['2017-1-1', '2017-12-31'];
printf('year (2017): ', value, spec);

value = dv('Q1 2017', 'quarter');
spec = ['2017-1-1', '2017-3-31'];
printf('quarter (Q1 2017): ', value, spec);

value = dv('Q2 2017', 'quarter');
spec = ['2017-4-1', '2017-6-30'];
printf('quarter (Q2 2017): ', value, spec);

value = dv('Q3 2017', 'quarter');
spec = ['2017-7-1', '2017-9-30'];
printf('quarter (Q3 2017): ', value, spec);

value = dv('Q4 2017', 'quarter');
spec = ['2017-10-1', '2017-12-31'];
printf('quarter (Q4 2017): ', value, spec);

printf('===========');

value = dv('January 2017', 'month');
spec = ['2017-1-1', '2017-1-31'];
printf('month (Jan 2017): ', value, spec);

value = dv('May 2017', 'month');
spec = ['2017-5-1', '2017-5-31'];
printf('month (May 2017): ', value, spec);

value = dv('June 2017', 'month');
spec = ['2017-6-1', '2017-6-30'];
printf('month (June 2017): ', value, spec);

value = dv('Dec 2017', 'month');
spec = ['2017-12-1', '2017-12-31'];
printf('month (Dec 2017): ', value, spec);

printf('===========');

value = dv('W1 2015', 'week');
spec = ['2014-12-29', '2015-1-4'];
printf('week (W1 2015): ', value, spec); //December 29, 2014

value = dv('W1 2016', 'week');
spec = ['2016-1-4', '2016-1-10'];
printf('week (W1 2016): ', value, spec); //January 4, 2016

value = dv('W1 2017', 'week');
spec = ['2017-1-2', '2017-1-8'];
printf('week (W1 2017): ', value, spec); //January 2, 2017

value = dv('W1 2018', 'week');
spec = ['2018-1-1', '2018-1-7'];
printf('week (W1 2018): ', value, spec); //January 1, 2018

value = dv('W1 2019', 'week');
spec = ['2018-12-31', '2019-1-6'];
printf('week (W1 2019): ', value, spec); //December 31, 2018

value = dv('W1 2020', 'week');
spec = ['2019-12-30', '2020-1-5'];
printf('week (W1 2020): ', value, spec); //December 30, 2019

value = dv('W1 2021', 'week');
spec = ['2021-1-4', '2021-1-10'];
printf('week (W1 2021): ', value, spec); //January 4, 2021

value = dv('W1 2022', 'week');
spec = ['2022-1-3', '2022-1-9'];
printf('week (W1 2022): ', value, spec); //January 3, 2022

printf('===========');

fiscalYear = new Date(2017, 0, 1, -5, 0, 0).toUTCString();
printf(fiscalYear);

value = dv('2017', 'fiscalYear');
spec = ['2017-1-1', '2017-12-31'];
printf('fiscal year (1/1): ', value, spec);

value = dv('Q1 2017', 'fiscalQuarter');
spec = ['2017-1-1', '2017-3-31'];
printf('fiscal quarter Q1 (1/1): ', value, spec);

value = dv('Q2 2017', 'fiscalQuarter');
spec = ['2017-4-1', '2017-6-30'];
printf('fiscal quarter Q2 (1/1): ', value, spec);

value = dv('Q3 2017', 'fiscalQuarter');
spec = ['2017-7-1', '2017-9-30'];
printf('fiscal quarter Q3 (1/1): ', value, spec);

value = dv('Q4 2017', 'fiscalQuarter');
spec = ['2017-10-1', '2017-12-31'];
printf('fiscal quarter Q4 (1/1): ', value, spec);

printf('---------');

fiscalYear = new Date('2017', 3, 1, 0, 0, 0).toUTCString();
printf(fiscalYear);

value = dv('2017', 'fiscalYear');
spec = ['2017-4-1', '2018-3-31'];
printf('fiscal year (4/1): ', value, spec);

value = dv('Q1 2017', 'fiscalQuarter');
spec = ['2017-4-1', '2017-6-30'];
printf('fiscal quarter Q1 (4/1): ', value, spec);

value = dv('Q4 2017', 'fiscalQuarter');
spec = ['2018-1-1', '2018-3-31'];
printf('fiscal quarter Q4 (4/1): ', value, spec);

printf('---------');

fiscalYear = new Date('2017', 3, 15, 0, 0, 0).toUTCString();
printf(fiscalYear);

value = dv('2017', 'fiscalYear');
spec = ['2017-4-15', '2018-4-14'];
printf('fiscal year (4/15): ', value, spec);

value = dv('Q1 2017', 'fiscalQuarter');
spec = ['2017-4-15', '2017-7-14'];
printf('fiscal quarter Q1 (4/15): ', value, spec);

value = dv('Q4 2017', 'fiscalQuarter');
spec = ['2018-1-15', '2018-4-14'];
printf('fiscal quarter Q4 (4/15): ', value, spec);

printf('===========');

value = df(2017);
spec = '2017';
printf('numeric year: ', value, spec);
value = df('2017');
spec = '2017';
printf('string year: ', value, spec);

value = df('1994-1-1', "time");
spec = "12:00:00 AM";
printf('numeric time: ', value, spec);

printf('===========');

date = new Date("1991-2-3, 4:05:06 AM");
value = gfutc([date]);
spec = ":%S";
printf('datetime second: ', value, spec);

date = new Date("1991-2-3, 4:05:00 AM");
value = gfutc([date]);
spec = "%I:%M";
printf('datetime minute: ', value, spec);

date = new Date("1991-2-3, 4:00:00 AM");
value = gfutc([date]);
spec = "%I %p";
printf('datetime hour: ', value, spec);

date = new Date("1991-2-3, 00:00:00 AM");
value = gfutc([date]);
spec = "%x";
printf('datetime day: ', value, spec);

date = new Date("1991-2-1, 00:00:00 AM");
value = gfutc([date]);
spec = "%B";
printf('datetime month: ', value, spec);

date = new Date("1991-1-1, 00:00:00 AM");
value = gfutc([date]);
spec = "%Y";
printf('datetime year: ', value, spec);

printf('===========');

function dv(label, type) {
    var re, rm, dt, wd, y1, y2, m1, m2, d1, d2;
    var values = [];
    var fy = new Date(fiscalYear);
    var dt = new Date();

    switch(type) {
        case 'year':
            //2017
            y1 = label;
            m1 = 1;
            d1 = 1;
            y2 = y1;
            m2 = 12;
            d2 = 31;
            break;

        case 'fiscalYear':
            //2017
            fy.setUTCFullYear(label);
            y1 = fy.getUTCFullYear();
            m1 = fy.getUTCMonth() + 1;
            d1 = fy.getUTCDate();
            fy.setUTCMonth(fy.getUTCMonth() + 12);
            fy.setUTCDate(fy.getUTCDate() - 1);
            y2 = fy.getUTCFullYear();
            m2 = fy.getUTCMonth() + 1;
            d2 = fy.getUTCDate(); //1-31
            break;

        case 'quarter':
            //Q1 2017
            re = /Q([1-4]{1})\s(\d{4})/;
            rm = label.match(re);
            y1 = y2 = rm[2];
            m2 = rm[1] * 3; // Q1 = 3
            m1 = m2 - 2; // Q1 = 1
            d1 = new Date(y1, m1 - 1, 1).getDate();
            d2 = new Date(y2, m2, 0).getDate();
            break;

        case 'fiscalQuarter':
            //Q1 2017
            re = /Q([1-4]{1})\s(\d{4})/;
            rm = label.match(re);
            fy.setUTCFullYear(rm[2]);
            fy.setUTCMonth((rm[1] - 1) * 3 + fy.getUTCMonth());
            y1 = fy.getUTCFullYear();
            m1 = fy.getUTCMonth() + 1;
            d1 = fy.getUTCDate();
            fy.setUTCMonth(m1 + 2);
            fy.setUTCDate(fy.getUTCDate() - 1);
            y2 = fy.getUTCFullYear();
            m2 = fy.getUTCMonth() + 1;
            d2 = fy.getUTCDate();
            break;

        case 'month':
            // May 2017
            dt = new Date(label);
            y1 = dt.getFullYear();
            m1 = dt.getMonth() + 1;
            d1 = dt.getDate();
            y2 = y1;
            m2 = m1;
            d2 = new Date(y2, m2, 0).getDate();
            break;

        case 'week':
            //W1 2017 (Sunday is first day)
            re = /W(\d{1,2})\s(\d{4})/;
            rm = label.match(re);
            dt = new Date(rm[2], 0, rm[1] * 7 - 6);
            wd = dt.getDay();
            if (wd > 4) {
              // if Sunday (0), +1   //5 - 0 % 4 = +1
              // if Saturday (6), +2 //5 - 0 % 4 = +1
              // if Friday (5), +3
              dt.setDate(dt.getDate() + (8 - wd) % 7);
            } else {
              // if Thursday (4), -3
              // if Wednesday (3), -2
              // if Tuesday (2), -1
              // if Monday (1), -0
              dt.setDate(dt.getDate() - wd + 1);
            }
            y1 = dt.getFullYear();
            m1 = dt.getMonth() + 1;
            d1 = dt.getDate();
            dt.setDate(dt.getDate() + 6);
            y2 = dt.getFullYear();
            m2 = dt.getMonth() + 1;
            d2 = dt.getDate();
            break;

        case 'day':
            //2017-4-1
            // mode = '$on'
            break;
    }

    values.push(y1 + '-' + m1 + '-' + d1);
    values.push(y2 + '-' + m2 + '-' + d2);

    return values;
}

function df(d, p, l) {
  var dateString, date, locale, spec, fmtr;

  // if the date value provided is a year
  dateString = d.toString();
  if (!isNaN(parseInt(dateString, 10)) && dateString.length === 4) {
    // append day and month parts to get correct UTC offset
    date = new Date(dateString + '-1-1'); // '1/1/' + dateString;
  } else {
    date = new Date(d);
  }
  date.setMilliseconds(date.getMilliseconds() - date.getTimezoneOffset() * 60000);

  if (!(date instanceof Date) || isNaN(date.valueOf())) {
    return d;
  }

  if (l && l.hasOwnProperty('utcFormat')) {
    // Use rebuilt locale formatter
    fmtr = l.utcFormat;
    spec = p && p.indexOf('%') !== -1 ? p : mf(date);
  } else {
    // Ensure locality object has all needed properties
    // TODO: this is expensive so consider removing
    locale = bl(l);
    fmtr = d3.timeFormatDefaultLocale(locale).utcFormat;
    spec = p && p.indexOf('%') !== -1 ? p : locale[p] || mf(date);
    // TODO: if not explicit pattern provided, we should use .multi()
  }

  return fmtr(spec)(date);
}

function mf(d) {
  var date = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
  var format;
  if (d3.timeSecond(date) < d) {
    format = '.%L'; //millisecond
  } else if (d3.timeMinute(date) < d) {
    format = ':%S'; //second
  } else if (d3.timeHour(date) < d) {
    format = '%I:%M'; //minute
  } else if (d3.timeDay(date) < d) {
    format = '%I %p'; //hour
  } else if (d3.timeMonth(date) < d) {
    format = '%x'; //day
    // format = (d3.timeWeek(date) < date ? formatDay : formatWeek);
  } else if (d3.timeYear(date) < d) {
    format = '%B'; //month
  } else {
    format = '%Y'; //year
  }
  return format;
}

function bl(l, d) {
  var locale = l || {};
  var deep = !!d;
  var unfer = function(a) {
        return a.join('|').split('|').map(function(b) {
          return !(b) ? '' : isNaN(b) ? b : +b;
        });
      };
  var definition = {
        'decimal': '.',
        'thousands': ',',
        'grouping': [3],
        'currency': ['$', ''],
        'dateTime': '%B %-d, %Y at %X %p GMT%Z', //%c
        'date': '%b %-d, %Y', //%x
        'time': '%-I:%M:%S %p', //%X
        'periods': ['AM', 'PM'],
        'days': ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        'shortDays': ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
        'months': ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        'shortMonths': ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        // Custom patterns
        'full': '%A, %c',
        'long': '%c',
        'medium': '%x, %X %p',
        'short': '%-m/%-d/%y, %-I:%M %p',
        'yMMMEd': '%a, %x',
        'yMEd': '%a, %-m/%-d/%Y',
        'yMMMMd': '%B %-d, %Y',
        'yMMMd': '%x',
        'yMd': '%-m/%-d/%Y',
        'yMMMM': '%B %Y',
        'yMMM': '%b %Y',
        'MMMd': '%b %-d',
        'MMMM': '%B',
        'MMM': '%b',
        'y': '%Y'
      };
  var def;

  for (var key in locale) {
    if (l.hasOwnProperty(key)) {
      def = locale[key];
      definition[key] = !deep || !Array.isArray(def) ? def : unfer(def);
    }
  }

  return definition;
}

function gf(values) {
  var dateFormats = ['multi', '.%L', ':%S', '%I:%M', '%I %p', '%x', '%b %d', '%B', '%Y']; //TODO: use locality format strings mmmmY, etc.
  var formatIndex = 0;

  formatIndex = values.length ? d3.min(values, function(date) {
    // var date = new Date(d.valueOf() - d.getTimezoneOffset() * 60000); //

      var format;
      // if round to second is less than date
      if (d3.timeSecond(date) < date) {
        // use millisecond format - .%L
        format = 1;
      }
      else
      // if round to minute is less than date
      if (d3.timeMinute(date) < date) {
        // use second format - :%S
        format = 2;
      }
      else
      // if round to hour is less than date
      if (d3.timeHour(date) < date) {
        // use minute format - %I:%M
        format = 3;
      }
      else
      // if round to day is less than date
      if (d3.timeDay(date) < date) {
        // use hour format - %I %p
        format = 4;
      }
      else
      // if round to month is less than date
      if (d3.timeMonth(date) < date) {
        // use day format - %x
        format = 5; // format = (d3.timeWeek(date) < date ? 4 : 5);
      }
      else
      // if round to year is less than date
      if (d3.timeYear(date) < date) {
        // use month format - %B
        format = 7;
      }
      else
      // as last resort
      {
        // use year format - %Y
        format = 8;
      }
      return format;
    }) : 0;
  return dateFormats[formatIndex];
}

function gfutc(values) {
  var dateFormats = ['multi', '.%L', ':%S', '%I:%M', '%I %p', '%x', '%b %d', '%B', '%Y']; //TODO: use locality format strings mmmmY, etc.
  var formatIndex = 0;

  formatIndex = values.length ? d3.min(values, function(date) {
      date.setUTCMilliseconds(date.getUTCMilliseconds() - date.getTimezoneOffset() * 60000);

      var format;
      // if round to second is less than date
      if (d3.utcSecond(date) < date) {
        // use millisecond format - .%L
        format = 1;
      }
      else
      // if round to minute is less than date
      if (d3.utcMinute(date) < date) {
        // use second format - :%S
        format = 2;
      }
      else
      // if round to hour is less than date
      if (d3.utcHour(date) < date) {
        // use minute format - %I:%M
        format = 3;
      }
      else
      // if round to day is less than date
      if (d3.utcDay(date) < date) {
        // use hour format - %I %p
        format = 4;
      }
      else
      // if round to month is less than date
      if (d3.utcMonth(date) < date) {
        // use day format - %x
        format = 5; // format = (d3.utcWeek(date) < date ? 4 : 5);
      }
      else
      // if round to year is less than date
      if (d3.utcYear(date) < date) {
        // use month format - %B
        format = 7;
      }
      else
      // as last resort
      {
        // use year format - %Y
        format = 8;
      }
      return format;
    }) : 0;
  return dateFormats[formatIndex];
}

function printf(l, v, s) {
  var p, val, spec;
  var c = 'blue';
  if (typeof v !== 'undefined' && typeof s !== 'undefined') {
    val = Array.isArray(v) ? v : [v, v];
    spec = Array.isArray(s) ? s : [s, s];
    c = (val[0] === spec[0] && val[1] === spec[1]) ? 'green' : 'red';
    p = '<p style="color:' + c + '">' + l +
        JSON.stringify(v, null, ' ') +
        (c === 'green' ? ' == ' : ' != ') +
        JSON.stringify(s, null, ' ') +
        '</p>';
  } else {
    p = '<p style="color:' + c + '">' + l + '</p>'
  }
  document.querySelector('.sc-demo').innerHTML += p;
}

</script>
</body>
</html>
